import glob
import networkx as nx
import matplotlib.pyplot as plt
import os
import sys
from androguard.misc import AnalyzeAPK


'''
    Created By: Akash Patel (akashpatelcse)
                MTECH (CSE) IIT Kanpur
                https://in.linkedin.com/in/akashpatelcse
'''

print("Ruun")
apkType = sys.argv[1].strip()
#apkType = "Derbin"
#apkType = "Andro"
print("Starting apkType")


gml_file_directory = str()
CSV_File = str()
label = str()
csv_file_directory = 'tmp_csvFiles/'


if apkType == "Derbin":
    gml_file_directory = "/home/akash/Desktop/GML File Creator/DerbinCallGraphs/" #Call Graph Directory of Malwares 
    label = "M"
    csv_file_directory = "Derbin_Csv/"   #Csv files of Malwares
else:
    gml_file_directory = "/home/akash/Desktop/GML File Creator/AndroCallGraphs/" #Call Graph Directory of Goodwares
    label = "G"
    csv_file_directory = "Andro_Csv/"    #Csv file of Goodware


num = int(1)
def CreateCSV(callGraph, appName):
    global num
    if num < 2410:
        num += 1
        return
    G = nx.read_gml(callGraph)
    dc = nx.degree_centrality(G)

    f = open(csv_file_directory + "CSV_" +appName+".csv","w")
    
    for apiCall in dc:
        f.write(str(apiCall) + "," + str(dc[apiCall]) + "\n")
    f.close()
    num += 1



num = int(1)

def mainFunction(location_directory):
    global num
    print("Starting for: "+ gml_file_directory)
    gml_Files = []
    for name in os.listdir(gml_file_directory):
        if os.path.isfile(os.path.join(gml_file_directory, name)):
            gml_Files.append(name)

    count = int(0)

    allReadyCreated = set(open("AlreadyDone.txt", "r+").readlines())

    print(allReadyCreated)
    for gmlFile in gml_Files:
        print(str(count))
        count += 1
        if True:
        #try:
            callGraph_Name = gml_file_directory + gmlFile
            if (gmlFile + "\n") in allReadyCreated:
                print("Already Created")
                continue
    
            CreateCSV(callGraph_Name, gmlFile.strip(".gml"))
            print("CSV Created")
            f = open("AlreadyDone.txt", "a")
            f.write(gmlFile+"\n")
            f.close()
        if False:
        #except:
            print("\n\n-------------------Error-----------------------\n\n")
            f = open("Error File.txt", 'a+')
            f.write(str(num) + "Error: "+ "\n")
            f.close()

    #Track Progress
    ff = open("Progress.txt", 'w+')
    ff.write("Closing " + location_directory)
    print("Closing " + location_directory)


mainFunction(gml_file_directory)

print("Closing the Program")
