import random
import glob
import networkx as nx
import matplotlib.pyplot as plt
import os
import sys
from androguard.misc import AnalyzeAPK

'''
    Created By: Akash Patel (akashpatelcse)
                MTECH (CSE) IIT Kanpur
                https://in.linkedin.com/in/akashpatelcse
'''

'''
    Note: I used Androzoo for Goodware Dataset, and Derbin for Malware Dataset
    So In some places in the script you can see androzoo instead of Goodware and Derbin instead of goodware.

    You have to run the program 2 times; 1st time for Malware files and 2nd time for Goodware Files 

    Files: 
        1. CallGraph_directory: All the call graph will be stored in this directory

'''

#-------------------------Configuration-------------------------------
apk_file_directory = [ '/home/akash/Dataset/Malware/']
#apk_file_directory = [ '/home/akash/Dataset/Goodware/']

CSV_Files = 'Malware_csvFiles/'
#CSV_Files = 'Goodware_csvFiles/'      

callGraph_directory = 'MalwareCallgraph/' #androzoo/Goodware Output Directory
#callGraph_directory = 'GoodwareCallGraphs/' #Derbin/Malware Output Directory

#-------------------------Configuration End --------------------------



def CreateCallGraphs(apkFile, callGraph_Name):
    command = str("androguard cg " + apkFile + " -o " + callGraph_Name)
    os.system(command)
    a, d, dx = AnalyzeAPK(apkFile)
    appName = a.get_app_name().strip().replace(" ","_")
    print("appName: "+appName)
    return appName



tmpvariable = 1
def mainFunction(location_directory):
    global num
    global tmpvariable
    print("Starting for: "+ location_directory)
    apks = []
    for name in os.listdir(location_directory):
        if os.path.isfile(os.path.join(location_directory, name)):
            apks.append(name)

    count = int(0)
    random.shuffle(apks)
    allReadyCreated = set(os.listdir(callGraph_directory))

    for apkFile in apks:
        print(str(count))
        count += 1
       # if True:
        try:
            #print("Starting " + apkFile)
            callGraph_Name = callGraph_directory + apkFile + ".gml"
            if (apkFile + ".gml") in allReadyCreated:
                print("Already Done")
                continue
            if tmpvariable > 0:
                tmpvariable -= 1
                continue
            appName =  CreateCallGraphs(location_directory + apkFile, callGraph_Name) 
            print("CallGraph Created")

        except:
            print("\n\n-------------------Error-----------------------\n\n")
            f = open("Error File.txt", 'a+')
            f.write(str(num) + "Error: " + apkFile + "\n")
            f.close()

    #Track Progress
    ff = open("Progress.txt", 'w+')
    ff.write("Closing " + location_directory)
    print("Closing " + location_directory)

for i in apk_file_directory:
    mainFunction(i)

print("Closing the Program")
