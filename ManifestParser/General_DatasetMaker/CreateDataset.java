package ManifestParser.General_DatasetMaker;




import ManifestParser.util.DatasetFolders;
import ManifestParser.util.ParserUtil;
import net.dongliu.apk.parser.ApkFile;
import net.dongliu.apk.parser.bean.ApkMeta;

import javax.xml.crypto.Data;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static ManifestParser.util.utilities.getFiles;
import static ManifestParser.util.utilities.getManifest;

public class CreateDataset {

    public static void main(String[] args){

        String Dataset = "D1";
//        AllFeatures.filePath = "/home/akash/Documents/N_CSVFiles/C/"+ Dataset +"__P+O_last_"+ java.time.LocalDateTime.now()+ ".csv";
//        AllFeatures.FeatureSetPath = "ManifestParser/General_featureSetMaker/output/Combined__D1_2022-05-26T20:37:29.847060.txt";
//        run(Dataset);
//
//        Dataset = "D2";
//        AllFeatures.filePath = "/home/akash/Documents/N_CSVFiles/C/"+ Dataset +"__P+O_last_"+ java.time.LocalDateTime.now()+ ".csv";
//        AllFeatures.FeatureSetPath = "ManifestParser/General_featureSetMaker/output/Combined__D2__2022-05-26T21:23:01.510656.txt";
//        run(Dataset);

        Dataset = "D3";
        AllFeatures.filePath = "/home/akash/Documents/N_CSVFiles/C/"+ Dataset +"_____P+O_last_"+ java.time.LocalDateTime.now()+ ".csv";
        AllFeatures.FeatureSetPath = "ManifestParser/General_featureSetMaker/output/Combined__D3__2022-05-26T21:56:29.907843.txt";
        run(Dataset);

        Dataset = "D20";
        AllFeatures.filePath = "/home/akash/Documents/N_CSVFiles/C/"+ Dataset +"___D20__P+O_last_"+ java.time.LocalDateTime.now()+ ".csv";
        AllFeatures.FeatureSetPath = "ManifestParser/General_featureSetMaker/output/Combined__D3__2022-05-26T21:56:29.907843.txt";
        run(Dataset);
    }

    public static void run(String Dataset)
    {

        AllFeatures f = new AllFeatures();
        f.writeHeading();

        String[] goodware = DatasetFolders.getGoodware(Dataset);
        String[] malware =  DatasetFolders.getMalware(Dataset);
        for(String folder : goodware) {
            String[] Files = getFiles(folder);
            System.out.println("Number of Files" + Files.length);
            for (String fileName : Files) {
                try {
                    AllFeatures.isMalware = 0;
                    apkDetails(folder + "/" + fileName);
                } catch (Exception ignored) {}
            }

        }

        for(String folder : malware) {
            String[] Files = getFiles(folder);
            System.out.println("Number of Files" + Files.length);
            for (String fileName : Files) {
                try {
                    AllFeatures.isMalware = 1;
                    apkDetails(folder + "/" + fileName);
                } catch (Exception ignored) {}
            }
        }
        System.out.println("CSV Saved: " + AllFeatures.filePath);
    }

    static void apkDetails(String apkPath){
        try (ApkFile apkFile = new ApkFile(new File(apkPath))) {
            ApkMeta apkMeta = apkFile.getApkMeta();

            String manifestFile = getManifest(apkPath);
            List<String> newList = new ArrayList<String>();


                newList.addAll(ParserUtil.getAttributes(manifestFile, "receiver"));


                newList.addAll(ParserUtil.getAttributes(manifestFile, "activity"));


                newList.addAll(ParserUtil.getAttributes(manifestFile, "service"));


                newList.addAll(ParserUtil.getPermissions(manifestFile));


                newList.addAll(ParserUtil.getUsesFeatures(apkPath));

           //     newList.addAll(ParserUtil.getApiCalls(apkPath));


            AllFeatures af = new AllFeatures();
            for(String s : newList){
                af.add(s);
            }
            af.writeToFile();
        } catch (IOException ex) {
            throw new RuntimeException(ex);
        }


    }


}


