package ManifestParser.PermissionsOnly;


import ManifestParser.util.DatasetFolders;
import net.dongliu.apk.parser.ApkFile;
import net.dongliu.apk.parser.bean.ApkMeta;
import org.jdom2.Attribute;
import org.jdom2.Document;
import org.jdom2.Element;
import org.jdom2.JDOMException;
import org.jdom2.input.SAXBuilder;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Locale;

import static ManifestParser.util.utilities.getFiles;
import static ManifestParser.util.utilities.getManifest;

public class CreateDataset {

    public static void main(String[] args)
    {
        PermissionsOnlyFeatures2015.filePath = "/home/akash/Documents/CsvFiles/ALLPermissionsOnlyDataset20_ "+ java.time.LocalDateTime.now()+ ".csv";
        PermissionsOnlyFeatures2015.featureVectorFile = "/home/akash/IdeaProjects/MalwareAnalysis/ManifestParser/PermissionsOnly/output/AllPermission_1819_permissionsFromAPkParser_2022-03-31T18:16:54.858541.txt";

        PermissionsOnlyFeatures2015 f = new PermissionsOnlyFeatures2015();
        f.writeHeading();
        int counter = 0;
        for(String folder : DatasetFolders.Goodware20) {
            String[] Files = getFiles(folder);
            for (String fileName : Files) {
                try {
                    PermissionsOnlyFeatures2015.isMalware = 0;
                    apkDetails(folder + "/" + fileName);
                } catch (Exception ignored) {}
                System.out.println(counter++);

            }
            System.out.println("Number of Files" + Files.length);
        }

        for(String folder : DatasetFolders.Malware20) {
            String[] Files = getFiles(folder);
            for (String fileName : Files) {
                try {
                    PermissionsOnlyFeatures2015.isMalware = 1;
                    apkDetails(folder + "/" + fileName);
                } catch (Exception ignored) {}
                System.out.println(counter++);
            }
        }
        System.out.println("CSV Saved: " + PermissionsOnlyFeatures2015.filePath);
    }

    static void apkDetails(String filePath){
        try (ApkFile apkFile = new ApkFile(new File(filePath))) {
            PermissionsOnlyFeatures2015 f = new PermissionsOnlyFeatures2015();
            ApkMeta apkMeta = apkFile.getApkMeta();
            permissionsOnlyDatasetMaker mp = new permissionsOnlyDatasetMaker(getManifest(filePath));
            //mp.SAXParser(getManifest(filePath), f);
            mp.getPermissionFromApkParser(apkMeta,f);
            f.writeHeading();
            f.writeToFile();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}


//Did not Tokenize the permissions.
class permissionsOnlyDatasetMaker {
    String xmlString;

    permissionsOnlyDatasetMaker(String xmlString) {
        this.xmlString = xmlString;
    }

    void SAXParser(String mani, PermissionsOnlyFeatures2015 f) {
        try {
            SAXBuilder sax = new SAXBuilder();
            InputStream targetStream = new ByteArrayInputStream(mani.getBytes());
            Document doc = sax.build(targetStream);
            Element rootNode = doc.getRootElement();
            checkPermissions(rootNode, f);
        } catch (IOException | JDOMException e) {
            e.printStackTrace();
        }
    }

    void checkPermissions(Element rootNode, PermissionsOnlyFeatures2015 f) {
        List<Element> usesPermissions = rootNode.getChildren("uses-permission");
        for (Element usesPermission : usesPermissions) {
            for (Attribute attri : usesPermission.getAttributes()) {
                String key = attri.getValue();
                if(key.contains(" "))
                    continue;
                key = key.toUpperCase(Locale.ROOT);
                f.add(key);
            }
        }
    }

    void getPermissionFromApkParser(ApkMeta apkMeta, PermissionsOnlyFeatures2015 f){
        for(String perm : apkMeta.getUsesPermissions()){
            String key = perm;
            String tag = "";
            if(key.contains(" ") || !key.contains("."))
                continue;
            key = key.toUpperCase(Locale.ROOT);
            f.add(key);
        }
    }
}

