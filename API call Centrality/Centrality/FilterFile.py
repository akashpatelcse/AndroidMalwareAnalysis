import os
import sys

'''
    Created By: Akash Patel (akashpatelcse)
                MTECH (CSE) IIT Kanpur
                https://in.linkedin.com/in/akashpatelcse
'''


apkType = sys.argv[1].strip()
#apkType = "Derbin"
#apkType = "Andro"

gml_file_directory = str()
CSV_File = str()
label = str()
csv_file_directory = 'tmp_csvFiles/'
Filtered_CSV_Files = str()

if apkType == "Derbin":
    gml_file_directory = "/home/akash/Desktop/CallGraphCreator/DerbinCallGraphs/"
    label = "M"
    csv_file_directory = "Derbin_Csv/"
    Filtered_CSV_Files = "Derbin_FilteredCSV/"
else:
    gml_file_directory = "/home/akash/Desktop/CallGraphCreator/AndroCallGraphs/"
    label = "G"
    csv_file_directory = "Andro_Csv/"
    Filtered_CSV_Files = "Andro_FilteredCSV/"


valid_class = {"Landroid", "Ljava"}

def ClassValid(cla):
	first = cla.split("/")[0]
	#print(first)
	if first in valid_class:
		return 1
	return 0

def FilterCSV(csv):
	f = open(csv_file_directory+csv, 'r')
	Lines = f.readlines()
	f.close()

	op = open(Filtered_CSV_Files+csv,'w')
	for line in Lines:
		apicall = line.split(",")
		if "other_Feature_" in apicall[0]:
			op.write(apicall[0] + ","+str(float(apicall[1])) + "\n")
			continue

		Call = list(apicall[0].replace("<analysis.MethodAnalysis ", "").split(";->"))
		if(ClassValid(Call[0])):
			fun = Call[1].split("(")[0]
			if(fun == "<init>" or fun == "valueOf" or fun == "value" or len(fun) < 3):
				continue
			#print(fun + " " + apicall[1])
			op.write(fun + ","+str(float(apicall[1])) + "\n")
	op.close()


CSVs = []
for name in os.listdir(csv_file_directory):
    if os.path.isfile(os.path.join(csv_file_directory, name)):
        CSVs.append(name)


count = int(0)
for csvFile in CSVs:
    print("\n" + str(count))
    count += 1
    FilterCSV(csvFile)
  

print("Closing the Program")